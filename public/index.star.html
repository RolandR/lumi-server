<!DOCTYPE html>
<html>
  <head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/lumi.js"></script>
    <script src="/javascripts/processing-1.3.6.js"></script>

    <script type="application/processing" data-processing-target="pjs">
      void setup() {
        size(32,32);
        frameRate(25);
      }

      void draw() {
        translate( width/2, height/2 );
        for( int j =20; j >=-1; j--) {
          if ( j % 2 == 0 ) {
            fill( 255,255,0);
          } else {
            fill(0,0,0);
          }
          beginShape();
          for( int i=0; i<10; i++) {
            int c = frameCount % 20;
            float r = (i % 2 == 0 ? 1 * max(0, j * 10 + c) : 2 * max(0,j * 10 + c) );
            vertex( r * cos( i*TWO_PI/10), r*sin(i*TWO_PI/10));
          }
          endShape(CLOSE);
        }
      }
    </script>

    <script>
      var frames = 0;
      var fps = 0;
      var started = new Date().getTime();
      setTimeout(function() {

        Processing.instances[0].externals.sketch.onFrameEnd = function() {
          var canv = document.getElementById("pjs");
          var context = canv.getContext("2d");
          var imgd = context.getImageData(0,0,32,32).data;
          var pix = [];
          
          // Skip Alpha-Channel
          for(var i=0, l=imgd.length; i<l; i+=4) {
            pix.push(imgd[i    ]); 
            pix.push(imgd[i + 1]); 
            pix.push(imgd[i + 2]); 
          }
          lumi.sendFrame(pix);
          
          if (new Date().getTime() - started > 1000) {
            fps = frames;
            frames = 0;
            console.log("fps: " + fps);
            started = new Date().getTime();
          }
          frames++;
        };
      }, 5000); 
    </script>
  </head>
  <body>
    <h1>HELLO</h1>
    <canvas id="pjs"> </canvas>
  </body>
</html>
